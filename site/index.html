<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EPL Lab</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: rgba(18,26,51,0.9);
      --panel2: rgba(18,26,51,0.65);
      --text: #e8ecff;
      --muted: #a4aed8;
      --accent: #7aa2ff;
      --good: #4ade80;
      --bad: #fb7185;
      --warn: #fbbf24;
      --border: rgba(255,255,255,0.10);
      --border2: rgba(255,255,255,0.06);
      --shadow: 0 12px 40px rgba(0,0,0,0.25);
    }

    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; background: radial-gradient(1200px 500px at 10% 0%, rgba(122,162,255,0.18), transparent 50%), var(--bg); color: var(--text); }

    header { padding: 26px 20px; border-bottom: 1px solid var(--border2); background: linear-gradient(180deg, rgba(122,162,255,0.10), transparent); }
    h1 { margin: 0 0 6px 0; font-size: 22px; letter-spacing: 0.2px; }
    p { margin: 0; color: var(--muted); }

    main { max-width: 1120px; margin: 0 auto; padding: 18px 20px 46px; display: grid; grid-template-columns: 1.25fr 0.75fr; gap: 16px; }

    .card { background: var(--panel); border: 1px solid var(--border2); border-radius: 14px; overflow: hidden; box-shadow: var(--shadow); backdrop-filter: blur(10px); }
    .card h2 { font-size: 13px; margin: 0; padding: 12px 14px; border-bottom: 1px solid var(--border2); color: var(--muted); letter-spacing: 0.35px; text-transform: uppercase; }
    .card .content { padding: 12px 14px; }

    table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
    th, td { padding: 8px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); text-align: left; vertical-align: middle; }
    th { color: var(--muted); font-weight: 650; position: sticky; top: 0; background: linear-gradient(180deg, rgba(18,26,51,0.98), rgba(18,26,51,0.92)); z-index: 1; }
    tbody tr:nth-child(2n) td { background: rgba(255,255,255,0.015); }
    tr:hover td { background: rgba(255,255,255,0.035); }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }

    .pill { display: inline-flex; gap: 6px; align-items: center; padding: 4px 10px; border-radius: 999px; border: 1px solid var(--border2); color: var(--muted); font-size: 12px; background: rgba(255,255,255,0.02); }

    .badge { display:inline-flex; align-items:center; justify-content:center; padding: 3px 8px; border-radius: 8px; border: 1px solid var(--border2); font-size: 12px; }
    .badge.good { color: var(--good); background: rgba(74,222,128,0.12); border-color: rgba(74,222,128,0.20); }
    .badge.bad { color: var(--bad); background: rgba(251,113,133,0.12); border-color: rgba(251,113,133,0.20); }
    .badge.neutral { color: var(--muted); background: rgba(255,255,255,0.02); }

    .form span { display:inline-block; width: 18px; height: 18px; line-height: 18px; text-align:center; border-radius: 6px; margin-right: 4px; font-size: 11px; }
    .W { background: rgba(74,222,128,0.18); color: var(--good); border: 1px solid rgba(74,222,128,0.35); }
    .D { background: rgba(251,191,36,0.14); color: var(--warn); border: 1px solid rgba(251,191,36,0.30); }
    .L { background: rgba(251,113,133,0.16); color: var(--bad); border: 1px solid rgba(251,113,133,0.32); }

    .row { display:flex; gap: 10px; align-items: center; flex-wrap: wrap; }

    .select { background: rgba(0,0,0,0.10); color: var(--text); border: 1px solid var(--border2); border-radius: 12px; padding: 8px 10px; }

    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }

    .muted { color: var(--muted); }

    .probbar { height: 8px; border-radius: 999px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); overflow: hidden; }
    .probbar > div { height: 100%; background: linear-gradient(90deg, rgba(122,162,255,0.85), rgba(122,162,255,0.30)); }

    details { border: 1px solid var(--border2); border-radius: 12px; background: rgba(255,255,255,0.02); padding: 10px 10px; }
    details + details { margin-top: 10px; }
    summary { cursor: pointer; color: var(--text); }

    @media (max-width: 980px) { main { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <header>
    <h1>EPL Lab</h1>
    <p class="mono muted">EPL results/table/form + model-based predictions (Elo + Poisson). <span id="meta" class="pill"></span></p>
  </header>

  <main>
    <section class="card">
      <h2>League Table (computed from matches)</h2>
      <div class="content">
        <div class="row" style="margin-bottom:10px; justify-content: space-between;">
          <div class="pill">Tie-break: Pts → GD → GF → name</div>
          <div class="pill">Tip: click a team to open details</div>
        </div>
        <div style="overflow:auto;">
          <table id="table">
            <thead>
              <tr>
                <th>#</th>
                <th>Team</th>
                <th class="mono">P</th>
                <th class="mono">W</th>
                <th class="mono">D</th>
                <th class="mono">L</th>
                <th class="mono">GF</th>
                <th class="mono">GA</th>
                <th class="mono">GD</th>
                <th class="mono">Pts</th>
                <th>Form (last 5)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <aside style="display:grid; gap:16px; align-content:start;">
      <div class="card">
        <h2>Team</h2>
        <div class="content">
          <div class="row" style="margin-bottom:10px;">
            <label class="pill" for="teamSel">Select</label>
            <select id="teamSel" class="select"></select>
          </div>
          <div id="teamBox"></div>
        </div>
      </div>

      <div class="card">
        <h2>Upcoming Predictions (Poisson + Elo)</h2>
        <div class="content">
          <div class="row" style="justify-content: space-between; margin-bottom: 8px;">
            <span class="pill">Not betting advice · model-based</span>
            <span class="pill" id="predMeta"></span>
          </div>
          <div style="overflow:auto; max-height: 520px;">
            <table id="predTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Match</th>
                  <th class="mono">H</th>
                  <th class="mono">D</th>
                  <th class="mono">A</th>
                  <th class="mono">xG*</th>
                  <th class="mono">ML</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div style="margin-top:10px; color: var(--muted); font-size:12px;">
            <div>* xG here means expected goals from a simple Poisson goals model (not event-based xG).</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Combo Suggestions (2–10 games)</h2>
        <div class="content">
          <div class="row" style="justify-content: space-between; margin-bottom: 8px;">
            <span class="pill">Informational only · model-based</span>
            <span class="pill" id="totoMeta"></span>
          </div>
          <div id="totoBox"></div>
          <div class="muted" style="margin-top:10px; font-size:12px;">
            <div>Joint probability is a naive product (independence assumption). Real outcomes are not independent.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>Value Picks (EV vs Odds)</h2>
        <div class="content">
          <div class="row" style="justify-content: space-between; margin-bottom: 8px;">
            <span class="pill">Informational only · model vs odds</span>
            <span class="pill" id="evMeta"></span>
          </div>
          <div style="overflow:auto; max-height: 360px;">
            <table id="evTable">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Match</th>
                  <th class="mono">Pick</th>
                  <th class="mono">p(model)</th>
                  <th class="mono">odds</th>
                  <th class="mono">EV</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div style="margin-top:10px; color: var(--muted); font-size:12px;">
            <div>EV uses decimal odds: EV = p*odds - 1. Requires <code>data/odds.json</code>.</div>
          </div>
        </div>
      </div>
    </aside>
  </main>

<script>
  function computeTable(matches) {
    const t = new Map();
    function ensure(name) {
      if (!t.has(name)) t.set(name, { team:name, P:0,W:0,D:0,L:0,GF:0,GA:0,GD:0,Pts:0, results:[] });
      return t.get(name);
    }
    const sortedMatches = [...matches].sort((a,b)=> (a.date||'').localeCompare(b.date||''));

    for (const m of sortedMatches) {
      if (typeof m.homeGoals !== 'number' || typeof m.awayGoals !== 'number') continue;
      const H = ensure(m.home);
      const A = ensure(m.away);
      H.P++; A.P++;
      H.GF += m.homeGoals; H.GA += m.awayGoals;
      A.GF += m.awayGoals; A.GA += m.homeGoals;

      if (m.homeGoals > m.awayGoals) {
        H.W++; A.L++; H.Pts += 3;
        H.results.push('W'); A.results.push('L');
      } else if (m.homeGoals < m.awayGoals) {
        A.W++; H.L++; A.Pts += 3;
        A.results.push('W'); H.results.push('L');
      } else {
        H.D++; A.D++; H.Pts += 1; A.Pts += 1;
        H.results.push('D'); A.results.push('D');
      }
    }

    for (const x of t.values()) x.GD = x.GF - x.GA;

    const rows = [...t.values()].sort((a,b)=>
      b.Pts - a.Pts || b.GD - a.GD || b.GF - a.GF || a.team.localeCompare(b.team)
    );

    return rows;
  }

  function formHtml(results) {
    const last5 = results.slice(-5);
    if (!last5.length) return '<span class="pill">-</span>';
    return `<span class="form">${last5.map(r=>`<span class="${r}">${r}</span>`).join('')}</span>`;
  }

  function renderTable(rows) {
    const tbody = document.querySelector('#table tbody');
    tbody.innerHTML = rows.map((r, idx)=>
      `<tr>
        <td class="mono">${idx+1}</td>
        <td><a href="#" data-team="${encodeURIComponent(r.team)}">${r.team}</a></td>
        <td class="mono">${r.P}</td>
        <td class="mono">${r.W}</td>
        <td class="mono">${r.D}</td>
        <td class="mono">${r.L}</td>
        <td class="mono">${r.GF}</td>
        <td class="mono">${r.GA}</td>
        <td class="mono">${r.GD}</td>
        <td class="mono">${r.Pts}</td>
        <td>${formHtml(r.results)}</td>
      </tr>`
    ).join('');

    tbody.querySelectorAll('a[data-team]').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        const team = decodeURIComponent(a.dataset.team);
        document.querySelector('#teamSel').value = team;
        window.location.hash = `team=${encodeURIComponent(team)}`;
        renderTeam(team);
      })
    })
  }

  let DATA = null;
  let PREDS = null;
  let TOTO = null;
  let EV = null;

  function renderTeam(team) {
    const box = document.getElementById('teamBox');
    if (!DATA) return;
    const matches = DATA.matches
      .filter(m=> (m.home===team || m.away===team) && typeof m.homeGoals==='number' && typeof m.awayGoals==='number')
      .sort((a,b)=> (a.date||'').localeCompare(b.date||''));

    const last = matches.slice(-8).reverse();
    const lines = last.map(m=>{
      const isHome = m.home===team;
      const gf = isHome ? m.homeGoals : m.awayGoals;
      const ga = isHome ? m.awayGoals : m.homeGoals;
      const opp = isHome ? m.away : m.home;
      const res = gf>ga?'W':gf<ga?'L':'D';
      return { date:m.date, opp, gf, ga, res, venue: isHome?'H':'A' };
    });

    const row = computeTable(DATA.matches).find(r=>r.team===team);
    if (!row) { box.innerHTML = '<div class="pill">No data</div>'; return; }

    // next fixtures/preds
    let next = [];
    if (PREDS?.upcoming?.length) {
      next = PREDS.upcoming
        .filter(x => x.home === team || x.away === team)
        .slice(0, 5);
    }

    box.innerHTML = `
      <div class="row" style="justify-content: space-between;">
        <div>
          <div style="font-size:18px; font-weight:700;">${team}</div>
          <div class="pill mono">P ${row.P} · W ${row.W} D ${row.D} L ${row.L} · GD ${row.GD} · Pts ${row.Pts}</div>
        </div>
        <div>${formHtml(row.results)}</div>
      </div>

      ${next.length ? `
      <div style="margin-top:12px;">
        <div class="pill">Next 5 predictions (Poisson)</div>
        <div style="margin-top:8px; overflow:auto;">
          <table>
            <thead>
              <tr><th>Date</th><th>Match</th><th class="mono">H</th><th class="mono">D</th><th class="mono">A</th><th class="mono">ML</th></tr>
            </thead>
            <tbody>
              ${next.map(x=>{
                const p = x.poisson;
                const ml = p?.mostLikelyScore ? `${p.mostLikelyScore.home}-${p.mostLikelyScore.away}` : '-';
                return `<tr>
                  <td class="mono">${x.date}</td>
                  <td>${x.home} vs ${x.away}</td>
                  <td class="mono">${p ? (p.pHome*100).toFixed(0)+'%' : '-'}</td>
                  <td class="mono">${p ? (p.pDraw*100).toFixed(0)+'%' : '-'}</td>
                  <td class="mono">${p ? (p.pAway*100).toFixed(0)+'%' : '-'}</td>
                  <td class="mono">${ml}</td>
                </tr>`;
              }).join('')}
            </tbody>
          </table>
        </div>
      </div>` : ''}

      <div style="margin-top:12px;">
        <div class="pill">Recent matches</div>
        <div style="margin-top:8px; overflow:auto;">
          <table>
            <thead>
              <tr><th>Date</th><th>H/A</th><th>Opp</th><th class="mono">GF</th><th class="mono">GA</th><th>Res</th></tr>
            </thead>
            <tbody>
              ${lines.map(x=>`<tr>
                <td class="mono">${x.date||''}</td>
                <td class="mono">${x.venue}</td>
                <td>${x.opp}</td>
                <td class="mono">${x.gf}</td>
                <td class="mono">${x.ga}</td>
                <td><span class="${x.res}" style="padding:2px 6px; border-radius:6px; display:inline-block;">${x.res}</span></td>
              </tr>`).join('')}
            </tbody>
          </table>
        </div>
      </div>
    `;
  }

  function renderPredTable() {
    const tbody = document.querySelector('#predTable tbody');
    if (!PREDS?.upcoming?.length) {
      tbody.innerHTML = `<tr><td colspan="7"><span class="pill">No predictions.json</span></td></tr>`;
      return;
    }

    const asOf = PREDS.asOfDate ? ` · asOf=${PREDS.asOfDate}` : '';
    const base = PREDS.baseDate ? ` · from=${PREDS.baseDate}` : '';
    document.getElementById('predMeta').textContent = `updatedAt=${PREDS.updatedAt}${asOf}${base}`;

    const rows = PREDS.upcoming.slice(0, 25);
    tbody.innerHTML = rows.map(x=>{
      const p = x.poisson;
      const ml = p?.mostLikelyScore ? `${p.mostLikelyScore.home}-${p.mostLikelyScore.away}` : '-';
      const xg = p ? `${p.lambdaHome.toFixed(2)}-${p.lambdaAway.toFixed(2)}` : '-';
      const top = p ? Math.max(p.pHome, p.pDraw, p.pAway) : 0;
      return `<tr>
        <td class="mono">${x.date}</td>
        <td>
          <div>${x.home} vs ${x.away}</div>
          <div class="probbar" title="top prob ${(top*100).toFixed(0)}%" style="margin-top:6px;"><div style="width:${(top*100).toFixed(1)}%"></div></div>
        </td>
        <td class="mono">${p ? (p.pHome*100).toFixed(0)+'%' : '-'}</td>
        <td class="mono">${p ? (p.pDraw*100).toFixed(0)+'%' : '-'}</td>
        <td class="mono">${p ? (p.pAway*100).toFixed(0)+'%' : '-'}</td>
        <td class="mono">${xg}</td>
        <td class="mono">${ml}</td>
      </tr>`;
    }).join('');
  }

  function renderToto() {
    const box = document.getElementById('totoBox');
    const meta = document.getElementById('totoMeta');

    if (!TOTO?.combos) {
      box.innerHTML = `<span class="pill">No toto.json</span>`;
      meta.textContent = '';
      return;
    }

    meta.textContent = `window=${TOTO.meta.windowDays}d · base=${TOTO.meta.baseDate}`;

    const ks = Object.keys(TOTO.combos).map(Number).sort((a,b)=>a-b);
    box.innerHTML = ks.map(k => {
      const c = TOTO.combos[String(k)];
      const pct = (c.jointProb * 100).toFixed(2);
      const items = c.games.map(g =>
        `<div class="mono" style="margin:4px 0;">${g.date} · ${g.match} · <span class=\"badge neutral\">${g.pick}</span> <span class=\"muted\">(${(g.prob*100).toFixed(0)}%)</span></div>`
      ).join('');

      return `
        <details ${k===2 ? 'open' : ''}>
          <summary>
            <div class="row" style="justify-content: space-between;">
              <span class="pill">${k} games</span>
              <span class="pill mono">joint≈${pct}%</span>
            </div>
          </summary>
          <div style="margin-top:10px;">${items}</div>
        </details>
      `;
    }).join('');
  }

  function renderEV() {
    const meta = document.getElementById('evMeta');
    const tbody = document.querySelector('#evTable tbody');

    if (!EV?.rows?.length) {
      meta.textContent = '';
      tbody.innerHTML = `<tr><td colspan="6"><span class="pill">No ev.json (need odds.json)</span></td></tr>`;
      return;
    }

    meta.textContent = `odds=${EV.meta.oddsSource} · updatedAt=${EV.meta.oddsUpdatedAt || ''}`;

    const rows = EV.rows.slice(0, 20);
    tbody.innerHTML = rows.map(r => {
      const b = r.picks.bestEV;
      const cls = b.ev >= 0 ? 'good' : 'bad';
      return `<tr>
        <td class="mono">${r.date}</td>
        <td>${r.home} vs ${r.away}</td>
        <td class="mono"><span class="badge neutral">${b.pick}</span></td>
        <td class="mono">${(b.p*100).toFixed(1)}%</td>
        <td class="mono">${b.odds.toFixed(2)}</td>
        <td class="mono"><span class="badge ${cls}">${(b.ev*100).toFixed(1)}%</span></td>
      </tr>`;
    }).join('');
  }

  async function main() {
    const res = await fetch('./data/epl.json');
    DATA = await res.json();

    // predictions are optional
    try {
      const pr = await fetch('./data/predictions.json');
      if (pr.ok) PREDS = await pr.json();
    } catch (e) {
      PREDS = null;
    }

    // combo suggestions are optional
    try {
      const tr = await fetch('./data/toto.json');
      if (tr.ok) TOTO = await tr.json();
    } catch (e) {
      TOTO = null;
    }

    // EV (requires odds.json) is optional
    try {
      const er = await fetch('./data/ev.json');
      if (er.ok) EV = await er.json();
    } catch (e) {
      EV = null;
    }

    document.getElementById('meta').textContent = `season=${DATA.season} · updatedAt=${DATA.updatedAt}`;

    const rows = computeTable(DATA.matches);
    renderTable(rows);

    renderPredTable();
    renderToto();
    renderEV();

    const sel = document.getElementById('teamSel');
    sel.innerHTML = rows.map(r=>`<option value="${r.team}">${r.team}</option>`).join('');
    sel.addEventListener('change', ()=>{
      window.location.hash = `team=${encodeURIComponent(sel.value)}`;
      renderTeam(sel.value);
    });

    const m = /team=([^&]+)/.exec(location.hash.replace('#',''));
    const initial = m ? decodeURIComponent(m[1]) : (rows[0]?.team || '');
    if (initial) {
      sel.value = initial;
      renderTeam(initial);
    }
  }

  main().catch(err=>{
    console.error(err);
    document.getElementById('meta').textContent = 'Failed to load data/epl.json';
  });
</script>
</body>
</html>
